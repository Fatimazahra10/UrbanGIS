@model IEnumerable<WebGIS.Models.Site>

@section Scripts {
    <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.26/"></script>
    <script>
require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/GeoJSONLayer"
], function(Map, MapView, GeoJSONLayer) {

    const geojsonLayer = new GeoJSONLayer({
        url: "http://172.205.217.231/qgisserver?SERVICE=WFS&MAP=/home/gisadmin/Documents/projects/casavm.qgs&VERSION=2.0.0&REQUEST=GetFeature&TYPENAME=Site&outputFormat=application/json"
            });

    const map = new Map({
        basemap: "streets-navigation-vector",
        layers: [geojsonLayer]
    });

    const view = new MapView({
        container: "mapDiv",
        map: map,
        center: [-7.62, 33.59],
        zoom: 10
    });

    document.addEventListener("click", function (e) {
    if (e.target && e.target.matches(".zoom-to-site")) {
      const siteId = e.target.getAttribute("data-siteid");

      // Interroger la couche pour trouver la géométrie du site
      geojsonLayer.queryFeatures({
        where: `id = ${siteId }`, // attention au nom de champ
        returnGeometry: true,
        outFields: ["*"]
      }).then(function (results) {
        if (results.features.length > 0) {
          const feature = results.features[0];
          view.goTo({
            target: feature.geometry,
            zoom: 14
          });
          view.graphics.removeAll(); // nettoyer
            view.graphics.add({
            geometry: feature.geometry,
            symbol: {
                type: "simple-fill",
                color: [0, 0, 255, 0.2],
                outline: {
                color: [0, 0, 255],
                width: 2
                }
            }
            })
        } else {
          console.warn("Site non trouvé");
        }
      }).catch(function (error) {
        console.error("Erreur lors de la requête :", error);
      });
    }
  });

   
});


    </script>
}
<h2>Sites</h2>

<div class="container">

   <div id="mapDiv" style="height: 500px; width: 100%;"></div>


    <!-- Tableau (en-dessous de la carte) -->
    
    <a asp-action="Create">Create New Site</a>
    <table class="table">
        <thead>
            <tr>
                <th>Site</th>
                <th>Reference fonci7re </th>
                <th> Etat </th>
                <th> Prefecture </th>
                <th> Commune / Arrondissement </th>
                <th>Action</th>
                <th>test</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td> @item.site </td>
                <td> @item.reference </td>
                <td> @item.etat </td>
                <td> @item.prefecture </td>
                <td> @item.commune_ce </td>
                <td><button class="btn btn-sm btn-primary zoom-to-site" data-siteid="@item.id">
                    Voir sur carte
                </button>
                </td>>
                <td>
                    <a asp-controller="Site" asp-action="Edit" asp-route-id="@item.id" class="btn btn-sm btn-primary">Modifier</a>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>
